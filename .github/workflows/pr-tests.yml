name: Pull Request Tests

# This workflow runs comprehensive tests on pull requests to ensure
# code quality and prevent regressions. Uses unified test scripts
# for consistent testing across environments.

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'third_party/**'
      - 'scripts/**'
      - 'CMakeLists.txt'
      - '.github/workflows/pr-tests.yml'
  
  # Allow manual triggering for testing workflow changes
  workflow_dispatch:

jobs:
  tests:
    runs-on: macos-latest
    timeout-minutes: 35
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup dependencies
      run: |
        # Install required tools
        brew install cmake googletest
        
        # Verify tools are available
        cmake --version
        
    - name: Initial project setup
      run: |
        # Use our unified build script for setup
        ./scripts/build.sh setup
    
    - name: Build project
      run: |
        # Use our unified build script for building
        ./scripts/build.sh debug
    
    - name: Run all tests (split binaries for speed)
      run: |
        # Use split test binaries for faster parallel execution
        cd build
        echo "Available test binaries:"
        ls -la bin/YMulatorSynthAU_*Tests || echo "No test binaries found"
        
        # Run tests that exist
        [ -f "./bin/YMulatorSynthAU_BasicTests" ] && ./bin/YMulatorSynthAU_BasicTests --gtest_brief &
        [ -f "./bin/YMulatorSynthAU_PresetTests" ] && ./bin/YMulatorSynthAU_PresetTests --gtest_brief &
        [ -f "./bin/YMulatorSynthAU_ParameterTests" ] && ./bin/YMulatorSynthAU_ParameterTests --gtest_brief &
        [ -f "./bin/YMulatorSynthAU_PanTests" ] && ./bin/YMulatorSynthAU_PanTests --gtest_brief &
        [ -f "./bin/YMulatorSynthAU_IntegrationTests" ] && ./bin/YMulatorSynthAU_IntegrationTests --gtest_brief &
        [ -f "./bin/YMulatorSynthAU_QualityTests" ] && ./bin/YMulatorSynthAU_QualityTests --gtest_brief &
        [ -f "./bin/YMulatorSynthAU_UITests" ] && ./bin/YMulatorSynthAU_UITests --gtest_brief &
        wait
    
    - name: Run specific test categories (verification)
      run: |
        echo "Current directory: $(pwd)"
        echo "Contents: $(ls -la)"
        
        # Always use absolute paths to avoid directory issues
        BUILD_DIR="$(pwd)/build"
        echo "Build directory: $BUILD_DIR"
        
        if [ -d "$BUILD_DIR" ]; then
          echo "=== Basic Tests ==="
          "$BUILD_DIR/bin/YMulatorSynthAU_BasicTests" --gtest_brief
          
          echo "=== Integration Tests ==="
          "$BUILD_DIR/bin/YMulatorSynthAU_IntegrationTests" --gtest_brief
          
          echo "=== Parameter Tests ==="
          "$BUILD_DIR/bin/YMulatorSynthAU_ParameterTests" --gtest_brief
        else
          echo "ERROR: Build directory not found at $BUILD_DIR"
          exit 1
        fi
    
    - name: Validate Audio Unit
      run: |
        # Use our unified test script for Audio Unit validation
        ./scripts/test.sh --auval
      continue-on-error: true  # Don't fail the workflow if auval has issues
    
    - name: Upload test results on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ github.run_number }}
        path: |
          build/Testing/
          build/auval_output.txt
          build/bin/YMulatorSynthAU_Tests
        retention-days: 7
        
    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          build/*.log
          build/CMakeFiles/CMakeOutput.log
          build/CMakeFiles/CMakeError.log
        retention-days: 3